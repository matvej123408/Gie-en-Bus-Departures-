<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gie√üen Bus Board (RMV)</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    body { margin:0; background:#000; color:#00ff9c; font-family: monospace; padding:16px; }
    h1 { text-align:center; margin: 0 0 10px; }
    select { width:100%; padding:10px; background:#111; color:#0f0; border:1px solid #0f0; font-size:16px; }
    .row { display:grid; grid-template-columns:70px 1fr 90px; gap:8px; padding:8px 0; border-bottom:1px solid #033; }
    .time { text-align:right; }
    .hint { opacity:.7; font-size:12px; text-align:center; margin-top:8px; }
  </style>
</head>
<body>
  <h1>üöå Gie√üen ‚Äî –¢–∞–±–ª–æ (RMV)</h1>
  <select id="stops"><option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫‚Ä¶</option></select>
  <div id="board">–í—ã–±–µ—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫—É</div>
  <div class="hint">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</div>

  <script>
    // –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–ô accessId –æ—Ç RMV
    const API_KEY = "1775f9f1-32b8-48ad-98c8-06b2f6276fa0";

    const stopsSelect = document.getElementById("stops");
    const board = document.getElementById("board");
    let currentStop = null;

    async function loadStops() {
      try {
        const url = `https://www.rmv.de/hapi/location.name?accessId=${API_KEY}&input=Gie√üen&format=json&type=S`;
        const res = await fetch(url);
        const data = await res.json();
        const stops = data.stopLocation || [];

        stopsSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫—É‚Ä¶</option>';
        stops.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.id;
          opt.textContent = s.name;
          stopsSelect.appendChild(opt);
        });

        if (!stops.length) stopsSelect.innerHTML = '<option value="">–û—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
      } catch (e) {
        console.error(e);
        stopsSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫</option>';
        board.textContent = "–ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É –∏–ª–∏ –∫–ª—é—á API";
      }
    }

    function minutesFromNow(timeStr) {
      if (!timeStr) return "‚Äî";
      const parts = timeStr.split(':');
      const now = new Date();
      const t = new Date(now);
      t.setHours(+parts[0], +parts[1], 0, 0);
      let min = Math.round((t - now) / 60000);
      if (min < 0) min += 24*60;
      return min > 0 ? (min + " –º–∏–Ω") : "—Å–µ–π—á–∞—Å";
    }

    async function loadDepartures(id) {
      try {
        board.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–æ‚Ä¶";
        const url = `https://www.rmv.de/hapi/departureBoard?accessId=${API_KEY}&id=${id}&format=json&maxJourneys=8`;
        const res = await fetch(url);
        const data = await res.json();
        const list = data.Departure || [];

        if (!list.length) {
          board.textContent = "–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è";
          return;
        }

        board.innerHTML = list.map(d => `
          <div class="row">
            <div>üöå ${d.line}</div>
            <div>${d.direction || ""}</div>
            <div class="time">${minutesFromNow(d.rtTime || d.time)}</div>
          </div>
        `).join("");
      } catch (e) {
        console.error(e);
        board.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–æ";
      }
    }

    stopsSelect.onchange = e => {
      currentStop = e.target.value;
      if (currentStop) loadDepartures(currentStop);
    };

    setInterval(() => { if (currentStop) loadDepartures(currentStop); }, 30000);

    loadStops();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>
</body>
</html>
