<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gie√üen Bus Board</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body {
      margin: 0;
      background: black;
      color: #00ff9c;
      font-family: monospace;
      padding: 20px;
    }
    h1 { text-align: center; }
    select {
      width: 100%;
      padding: 10px;
      font-size: 18px;
      background: #111;
      color: #0f0;
      border: 1px solid #0f0;
      margin-bottom: 20px;
    }
    .row {
      display: grid;
      grid-template-columns: 70px 1fr 80px;
      gap: 8px;
      border-bottom: 1px solid #033;
      padding: 8px 0;
      font-size: 20px;
    }
    .time { text-align: right; }
    .hint { opacity: .7; font-size: 14px; text-align:center; }
  </style>
</head>
<body>
  <h1>üöå Gie√üen ‚Äî –¢–∞–±–ª–æ</h1>
  <select id="stops">
    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫‚Ä¶</option>
  </select>
  <div id="board">–í—ã–±–µ—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫—É</div>
  <div class="hint">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥</div>

  <script>
    const stopsSelect = document.getElementById("stops");
    const board = document.getElementById("board");
    let currentStop = null;

    async function loadStops() {
      try {
        const res = await fetch("https://api.transport.rest/stops?query=Gie√üen&results=50");
        const data = await res.json();
        const stops = Array.isArray(data) ? data : (data.stops || []);

        stopsSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫—É‚Ä¶</option>';
        stops.forEach(stop => {
          const opt = document.createElement("option");
          opt.value = stop.id;
          opt.textContent = stop.name;
          stopsSelect.appendChild(opt);
        });

        if (!stops.length) {
          stopsSelect.innerHTML = '<option value="">–û—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
        }
      } catch (e) {
        console.error(e);
        stopsSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫</option>';
        board.textContent = "–ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É";
      }
    }

    function minutesFromNow(iso) {
      if (!iso) return "‚Äî";
      const min = Math.round((new Date(iso) - new Date()) / 60000);
      if (isNaN(min)) return "‚Äî";
      return min > 0 ? (min + " –º–∏–Ω") : "—Å–µ–π—á–∞—Å";
    }

    async function loadDepartures(id) {
      try {
        board.textContent = "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–æ‚Ä¶";
        const res = await fetch(`https://api.transport.rest/stops/${id}/departures?duration=30`);
        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.departures || data);

        if (!list || !list.length) {
          board.textContent = "–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π –≤ –±–ª–∏–∂–∞–π—à–∏–µ 30 –º–∏–Ω—É—Ç";
          return;
        }

        board.innerHTML = list.slice(0, 8).map(d => {
          const line = d.line?.name || d.line || "?";
          const dir = d.direction || "";
          const when = d.when || d.plannedWhen;
          return `
            <div class="row">
              <div>üöå ${line}</div>
              <div>${dir}</div>
              <div class="time">${minutesFromNow(when)}</div>
            </div>
          `;
        }).join("");
      } catch (e) {
        console.error(e);
        board.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–æ";
      }
    }

    stopsSelect.onchange = e => {
      currentStop = e.target.value;
      if (currentStop) loadDepartures(currentStop);
    };

    setInterval(() => {
      if (currentStop) loadDepartures(currentStop);
    }, 30000);

    loadStops();
  </script>
</body>
</html>
